#!/bin/sh

# source config
. "$(dirname "$0")/aic.conf"

# usage collab [-cB] <user> <repo> [branch]
# -c: clean up clone after use
# -B: don't write bytecode (.pyc files)
# examples
# collab archlinux archinstall master
# collab -cB h8d13 archinstall-patch dot-resume

# if not branch is provided we remove the -b altogether from constructor
# and clone as the repo name instead 

# parse flags
clean_after=0
py_flags=""
[ "$1" = "-c" ] && clean_after=1 && shift
[ "$1" = "-B" ] && py_flags="-B" && shift
[[ "$1" =~ ^-[cB]+$ ]] && [[ "$1" == *c* ]] && clean_after=1
[[ "$1" =~ ^-[cB]+$ ]] && [[ "$1" == *B* ]] && py_flags="-B"
[[ "$1" =~ ^-[cB]+$ ]] && shift

# determine we have at least arg1 | arg2
[ $# -lt 2 ] && echo "Usage: collab [-cB] <user> <repo> [branch]" >&2 && exit 1

# Determine target directory and branch
if [ -n "$3" ]; then
    #has branch clone it with target name
    target_dir="$3"
    branch_arg="-b $3"
else
    # no branch clone it as repo name
    target_dir="$2"
    branch_arg=""
fi

# ensure we clone fresh delete if present delete with priv
if [ -d "$target_dir" ]; then
    sudo rm -rf "$target_dir"; echo "Cleaned $target_dir"
fi

git clone $branch_arg "$provider/$1/$2" "$target_dir"

# run main module with dev flags
cd "$target_dir" || exit 1
sudo python $py_flags -m archinstall "${dev_flags[@]}"

# cleanup if flag was set
[ $clean_after -eq 1 ] && cd .. && sudo rm -rf "$target_dir" && echo "Cleaned up $target_dir"